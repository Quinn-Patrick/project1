<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Reimbursement Portal</title>
    
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     
     
</head>

<body>
    <div class="jumbotron">
        <h1>Expense Reimbursement Portal</h1>
        <p class = 'lead'>View Your Past Reimbursements</p>
    </div>
    <div id = 'block' class = 'container'>
        
    </div>
    
    
    <script>
    	 let userObject = JSON.parse(sessionStorage.getItem("currentUser"));
    	 let permission = userObject.role;
    	 console.log(userObject + ", " + typeof(userObject));
    	 console.log(permission);
	     let xhr = new XMLHttpRequest;
	     let url = "http://localhost:8080/project1web/viewRequest";
	     xhr.onreadystatechange = function() {
	     	  if(this.readyState == 4 && this.status == 200) {
	     		  console.log(this.responseText);
	     		  data = JSON.parse(this.responseText);
	     		  for(i = 0; i < data.length; i++){
	     			  currentId = data[i].reimbId;
	     			  approved = data[i].status;
	     			  //Put in the main four rows-------------
	     			  let row1 = document.createElement('div');
	     			  row1.setAttribute('class', 'row');
	     			  row1.setAttribute('style', 'background-color:lightgray');
	     			  document.getElementById('block').appendChild(row1);
	     			  let row2 = document.createElement('div');
	     			  row2.setAttribute('class', 'row');
	     			  document.getElementById('block').appendChild(row2);
	     			  let row3 = document.createElement('div');
	     			  row3.setAttribute('style', 'background-color:lightgray');
	     			  row3.setAttribute('class', 'row');
	     			  document.getElementById('block').appendChild(row3);
	     			  let row4 = document.createElement('div');
	     			  row4.setAttribute('class', 'row');
	     			  document.getElementById('block').appendChild(row4);
	     			  //----------------------------------------
	     			  
	     			  
	     			  
	     			  //Dress up row 1--------------------------
	     			  //Create each cell
	     			  let row1Cell = [document.createElement('div'),
	     			  document.createElement('div'),
	     			  document.createElement('div')];
	     			  //Give each cell the proper attributes
	     			  row1Cell[0].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  row1Cell[1].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  row1Cell[2].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  //Give each cell its contents
	     			  let node = document.createTextNode(`ID: ${data[i].reimbId}`);
	     			  row1Cell[0].appendChild(node);
	     			  node = document.createTextNode(`Author: ${data[i].authorName}`);
	     			  row1Cell[1].appendChild(node);
	     			  node = document.createTextNode(`Amount: \$${data[i].amount}`);
	     			  row1Cell[2].appendChild(node);
	     			  //Append the cells to row 1
	     			  row1.appendChild(row1Cell[0]);
	     			  row1.appendChild(row1Cell[1]);
	     			  row1.appendChild(row1Cell[2]);
	     			  //----------------------------------------
	     			  //Dress up row 2--------------------------
	     			  //Create each cell
	     			  let row2Cell = document.createElement('div');
	     			  //Give each cell the proper attributes
	     			  row2Cell.setAttribute('class', "col-sm-12 col-md-12 col-lg-12");
	     			  //Give each cell its contents
	     			  node = document.createTextNode(`Description: ${data[i].description}`);
	     			  row2Cell.appendChild(node);
	     			  //Append the cells to row 1
	     			  row2.appendChild(row2Cell);
	     			  //----------------------------------------
	     			  //Dress up row 3--------------------------
	     			  //Create each cell
	     			  let row3Cell = [document.createElement('div'),
	     			  document.createElement('div'),
	     			  document.createElement('div')];
	     			  //Give each cell the proper attributes
	     			  row3Cell[0].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  row3Cell[1].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  row3Cell[2].setAttribute('class', "col-sm-6 col-md-3 col-lg-3");
	     			  //Give each cell its contents
	     			  node = document.createTextNode(`Type: ${data[i].typeName}`);
	     			  row3Cell[0].appendChild(node);
	     			  node = document.createTextNode(`Status: ${data[i].statusName}`);
	     			  row3Cell[1].appendChild(node);
	     			  node = document.createTextNode(`Resolver: ${data[i].resolverName}`);
	     			  row3Cell[2].appendChild(node);
	     			  //Append the cells to row 1
	     			  row3.appendChild(row3Cell[0]);
	     			  row3.appendChild(row3Cell[1]);
	     			  row3.appendChild(row3Cell[2]);
	     			  //----------------------------------------
	     			  //Dress up row 4--------------------------
	     			  //Create each cell
	     			  let row4Cell = [document.createElement('div'),
	     			  document.createElement('div')];
	     			  //Give each cell the proper attributes
	     			  row4Cell[0].setAttribute('class', "col-sm-6 col-md-6 col-lg-6");
	     			  row4Cell[1].setAttribute('class', "col-sm-6 col-md-6 col-lg-6");
	     			 
	     			  //Give each cell its contents
	     			  let sub = data[i].submitted;
	     			  node = document.createTextNode(`Submitted: ${sub.year}-${monCon(sub.monthValue)}-${sub.dayOfMonth} ${sub.hour}:${sub.minute}:${sub.second}`);
	     			  row4Cell[0].appendChild(node);
	     			  let res = data[i].resolved;
	     			  if(res === null) node = document.createTextNode('Unresolved');
	     			  else node = document.createTextNode(`Resolved: ${res.year}-${monCon(res.monthValue)}-${res.dayOfMonth} ${res.hour}:${res.minute}:${res.second}`);
	     			  row4Cell[1].appendChild(node);
	     			  
	     			  //Append the cells to row 1
	     			  row4.appendChild(row4Cell[0]);
	     			  row4.appendChild(row4Cell[1]);
	     			  
	     			  //----------------------------------------
	     			  
	     			  let row5 = document.createElement('div');
	     			  row5.setAttribute('class', 'row');
	     			  row5.setAttribute('id', 'row5'+currentId);
	     			  document.getElementById('block').appendChild(row5);
	     			  //Add row 5 only if the user is a finance manager
	     			  if(permission == 1 && approved == 0){
	     				  
		     			  let approveButton = document.createElement('button');
		     			  approveButton.innerHTML = "Approve";
		     			  approveButton.setAttribute('class', 'btn btn-success');
		     			  approveButton.setAttribute('onclick', 'approveRequest(' + currentId + ')');
		     			  row5.appendChild(approveButton);
		     			  
		     			  let denyButton = document.createElement('button');
		     			  denyButton.innerHTML = "Deny";
		     			  denyButton.setAttribute('class', 'btn btn-danger');
		     			  denyButton.setAttribute('onclick', 'denyRequest(' + currentId + ')');
		     			  row5.appendChild(denyButton);
		     			  
	     			  }
	     			 /*  let imageButton = document.createElement('button');
	     			  imageButton.innerHTML = "Show Image";
	     			  imageButton.setAttribute('class', 'btn btn-primary');
	     			  imageButton.setAttribute('onclick', 'loadImage(' + currentId + ')');
	     			  row5.appendChild(imageButton); */
	     			  
	     			  
	     			//add a rule to help keep things organized
	     			  let hr = document.createElement('hr');
	     			  document.getElementById('block').appendChild(hr);
	     		  }
	     	  }
	     }
	     function monCon(monthVal){
	    	 switch(monthVal){
	    	 case(1): return 'Jan';
	    	 case(2): return 'Feb';
	    	 case(3): return 'Mar';
	    	 case(4): return 'Apr';
	    	 case(5): return 'May';
	    	 case(6): return 'Jun';
	    	 case(7): return 'Jul';
	    	 case(8): return 'Aug';
	    	 case(9): return 'Sep';
	    	 case(10): return 'Oct';
	    	 case(11): return 'Nov';
	    	 case(12): return 'Dec';
	    	 
	    	 }
	     }
	     
	     xhr.open("GET", url);
	     xhr.send();
	     
	     function approveRequest(req){
	    	 let emp = JSON.parse(sessionStorage.getItem("currentUser"));
	    	 
	    	 let resName = emp.userId;
	    	 
	    	 let xhr = new XMLHttpRequest();
	    	 let basicdata = {
	    			 reimbId: req,
	    			 approved: true,
	    			 resolver: resName,
	    	 }
	    	 let url = "http://localhost:8080/project1web/viewRequest";
	    	 xhr.onreadystatechange = function(){
	    		 console.log('Ready state changed to ' + this.readyState);
	    		 if(xhr.readyState == 4 && xhr.status == 200){
	    			 console.log('Made it here.');
	    			 window.location = "http://localhost:8080/project1web/frontPage.html";
	    		 }
	    		 
	    	 }
	    	 xhr.open("POST", url);
	    	 xhr.send(JSON.stringify(basicdata));
	     }
	     
	     function denyRequest(req){
	    	 let emp = JSON.parse(sessionStorage.getItem("currentUser"));
	    	 console.log(emp);
	    	 let resName = emp.username;
	    	 
	    	 let xhr = new XMLHttpRequest();
	    	 let basicdata = {
	    			 reimbId: req,
	    			 approved: false,
	    			 resolver: emp.userId,
	    	 }
	    	 let url = "http://localhost:8080/project1web/viewRequest";
	    	 xhr.onreadystatechange = function(){
	    		 console.log('Ready state changed to ' + xhr.readyState);
	    		 console.log('status changed to ' + xhr.status);
	    		 if(xhr.readyState == 4 && xhr.status == 200){
	    			 console.log('Made it here.');
	    			 window.location = "http://localhost:8080/project1web/frontPage.html";
	    		 }
	    		 
	    	 }
	    	 xhr.open("POST", url);
	    	 xhr.send(JSON.stringify(basicdata));
	     }
	     
	     function loadImage(id){
    		let xhr = new XMLHttpRequest;
    		let url = "http://localhost:8080/project1web/loadImage";
    		xhr.onreadystatechange = function() {
    			  if(xhr.readyState == 4 && xhr.status == 200) {
    				  console.log(typeof(this.responseText));
    				  image = document.createElement('img');
    				  image.setAttribute('src', "data:image/png;base8,"+ _arrayBufferToBase64(toUTF8Array(this.responseText)));
    				  document.getElementById('row5'+id).appendChild(image);
    				  
    			  }
    		}
    		
    		function _arrayBufferToBase64( buffer ) {
    		    var binary = '';
    		    var bytes = new Uint8Array( buffer );
    		    var len = bytes.byteLength;
    		    for (var i = 0; i < len; i++) {
    		        binary += String.fromCharCode( bytes[ i ] );
    		    }
    		    return window.btoa( binary );
    		}
    		
    		function toUTF8Array(str) {
    		    var utf8 = [];
    		    for (var i=0; i < str.length; i++) {
    		        var charcode = str.charCodeAt(i);
    		        if (charcode < 0x80) utf8.push(charcode);
    		        else if (charcode < 0x800) {
    		            utf8.push(0xc0 | (charcode >> 6), 
    		                      0x80 | (charcode & 0x3f));
    		        }
    		        else if (charcode < 0xd800 || charcode >= 0xe000) {
    		            utf8.push(0xe0 | (charcode >> 12), 
    		                      0x80 | ((charcode>>6) & 0x3f), 
    		                      0x80 | (charcode & 0x3f));
    		        }
    		        // surrogate pair
    		        else {
    		            i++;
    		            // UTF-16 encodes 0x10000-0x10FFFF by
    		            // subtracting 0x10000 and splitting the
    		            // 20 bits of 0x0-0xFFFFF into two halves
    		            charcode = 0x10000 + (((charcode & 0x3ff)<<10)
    		                      | (str.charCodeAt(i) & 0x3ff));
    		            utf8.push(0xf0 | (charcode >>18), 
    		                      0x80 | ((charcode>>12) & 0x3f), 
    		                      0x80 | ((charcode>>6) & 0x3f), 
    		                      0x80 | (charcode & 0x3f));
    		        }
    		    }
    		    return utf8;
    		}
    		
    		console.log(id);
    		let data = {reimbId: id,};
    		xhr.open("POST", url);
    		xhr.send(JSON.stringify(id));
    	}
	     
     </script> 
</body>

</html>